#!/bin/perl

use FindBin;
use lib "$FindBin::Bin/../lib";
use Patcher;
use Getopt::Long;
use File::Slurp;

my @a;
GetOptions(
    "define|d=s" => sub {
        my ($opt, $set) = @_;
        die "you must specify key=value for $opt"
            unless $set =~ /^([^=]*)=(.*)/;
        push(@a, [ def => $1, $2 ]);
    },
    "<>" => sub {
        push(@a, [ load => $_[0] ]);
    },
) or die "bad commad line arguments";

eval {
    for my $a (@a) {
        if ($a->[0] eq 'def') {
            shift @$a;
            Patcher::modify_context(@$a);
            next;
        }
        if ($a->[0] eq 'load') {
            shift @$a;
            Patcher::load_config(@$a);
            next;
        }
        Patcher::_die "unknown action type '$a->[0]'";
    }
};

sub any_key {
    my $err = shift;
    if ($^O =~ /Win/) {
        print "$err\n" if $err;
        print "press any key to continue..\n";
        getc;
    }
}

if ($@) {
    $| = 1;
    any_key($@);
    die $@;
}
any_key();
